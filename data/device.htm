<!DOCTYPE html>
<html lang="ru">
 <head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="/style.css">
  <script type="text/javascript" src="/function.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Страница управления</title>
  <script type="text/javascript">
   function handleServerResponse(){
    var img = _('.thumb img'),
        canvas = _('#cs'),
        result = _('.result'),
        preview = _('.preview'),x = '',y = '';
    // click function
    img.addEventListener('click', function(e){
     // chrome
     if(e.offsetX) {
      x = e.offsetX;
      y = e.offsetY;
     }
     // firefox
     else if(e.layerX) {
      x = e.layerX;
      y = e.layerY;
     }
     useCanvas(canvas,img,function(){
      // get image data
      var p = canvas.getContext('2d').getImageData(x, y, 1, 1).data;
      r_rgb =p[0];
      g_rgb =p[1];
      b_rgb =p[2];
      document.getElementById('set-time').style.display="block";
      //on_rgb(this,p[0],p[1],p[2]);
     });
    },false);
    // preview function mousemove
    img.addEventListener('mousemove', function(e){
     // chrome
     if(e.offsetX) {
      x = e.offsetX;
      y = e.offsetY;
     }
     // firefox
     else if(e.layerX) {
      x = e.layerX;
      y = e.layerY;
     }
     useCanvas(canvas,img,function(){
      var p = canvas.getContext('2d').getImageData(x, y, 1, 1).data;
      preview.style.background = rgbToHex(p[0],p[1],p[2]);
     });
    },false);
    document.body.style.backgroundColor="rgb("+jsonResponse.rgb+")";
   }

   function useCanvas(el,image,callback){
    el.width = image.width;
    el.height = image.height;
    el.getContext('2d').drawImage(image, 0, 0, image.width, image.height);
    return callback();
   }
   function _(el){
    return document.querySelector(el);
   };
   function componentToHex(c) {
    var hex = c.toString(16);
    return hex.length == 1 ? "0" + hex : hex;
   }
   function rgbToHex(r, g, b) {
    return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
   }
   function findPos(obj) {
    var curleft = 0, curtop = 0;
    if (obj.offsetParent) {
     do {
      curleft += obj.offsetLeft;
      curtop += obj.offsetTop;
     } while (obj = obj.offsetParent);
     return { x: curleft, y: curtop };
    }
    return undefined;
   }

   function led(submit){
    server = "/led";
    send_request(submit,server);
   }
   function set_rgb(submit,r,g,b,t){
    document.body.style.background=rgbToHex(r,g,b);
    server = "/rgb?r="+r+"&g="+g+"&b="+b+"&t="+t+"&s="+val('sound')*10;
    document.getElementById('url1').innerHTML='<a href="http://'+document.domain+server+'" target="_blank">http://'+document.domain+server+'</a>';
    if(navigator.onLine) {
     xhr = new XMLHttpRequest();
     xhr.open("GET","https://api.ipify.org?format=text",true);
     xhr.onload = function () {
      if (xhr.readyState === xhr.DONE) {
       if (xhr.status === 200) {
        document.getElementById('url2').innerHTML='<a href="http://'+xhr.responseText+server+'" target="_blank">http://'+xhr.responseText+server+'</a>';
       }
      }
     };
     xhr.send(null);
    }
    send_request(submit,server);
   }
   function on_rgb(submit,t){
    document.getElementById('set-time').style.display="none";
    set_rgb(submit,r_rgb,g_rgb,b_rgb,t);
   }
   function set_time(submit){
    server = "/TimeLed?t="+val('led');
    send_request(submit,server);
   }
   function set_time1(submit){
    server = "/times1?time1="+val('time1');
    send_request(submit,server);
   }
   function set_time2(submit){
    server = "/times2?time2="+val('time2');
    send_request(submit,server);
   }
   function ddns(submit){
    server = "/ddns?url="+val('ddns').replace(/&/g, '%26');
    send_request(submit,server);
   }
  </script>
  <style type="text/css">
   #set-time {
    z-index:111;
    background-color:#fff;
    box-shadow:0 12px 15px rgba(0, 0, 0, 0.4);
    padding:20px;
    margin-top:-45%;
    position:relative;
   }
  </style>
 </head>
 <body onload="load();">
  <div class="container">
   <div class="row" style="text-align:center;">
    <h1 style="margin:50px;">Страница управления</h1>
    <div class="col-sm-offset-2 col-sm-8 col-md-offset-3 col-md-6">
     <h5 class="alert-info">{{SSDP}}</h5>
     <a class="btn btn-block btn-danger" href="/">Страница устройств</a>
     <a class="btn btn-block btn-default" href="/setup.htm">Доп. настройки</a>
     <hr>
     <div class="alert alert-dismissible alert-info">С помощью сервиса <a href="https://ifttt.com/myrecipes/personal" target="_blank">ifttt.com</a> Лампа может включатся по множествам сценариев, например: новое сообщение в facebook, twitter, <a href="#" onclick="toggle('hide');return false">подробнее...</a><span id="hide" class="hidden">задания в Google calendar, почта и многое другое. Подробней о том как это сделать вы можете посмотреть видео <a href="https://youtu.be/3PVQYLQ-XDQ" target="_blank">здесь</a>.<strong><br>Локальная ссылка: <span id="url1">Выберите цвет</span><br>Глобальная ссылка: <span id="url2">Выберите цвет</span></strong></span>
     </div>
     <div class="thumb">
      <div class="preview"></div>
      <img alt="" style="cursor:pointer;width:100%;" src="/swatches.png" />
     </div>
     <div class="row">
      <div class="col-sm-offset-3 col-sm-6" id="set-time" style="display:none;">
       <h5 class="alert-warning">Время</h5>
       <h4>На сколько минут включить?</h4>
       <div class="btn-group">
        <input type="submit" class="btn btn-primary btn-sm" onclick="on_rgb(this,60)" value="1">
        <input type="submit" class="btn btn-primary btn-sm" onclick="on_rgb(this,300)" value="5">
        <input type="submit" class="btn btn-primary btn-sm" onclick="on_rgb(this,600)" value="10">
        <input type="submit" class="btn btn-primary btn-sm" onclick="on_rgb(this,1500)" value="15">
        <input type="submit" class="btn btn-primary btn-sm" onclick="on_rgb(this,1800)" value="30">
       </div>
       <br>
       <div class="btn-group">
        <input type="submit" class="btn btn-primary btn-sm" onclick="on_rgb(this,3600)" value="60">
        <input type="submit" class="btn btn-primary btn-sm" onclick="on_rgb(this,5400)" value="1:30">
        <input type="submit" class="btn btn-primary btn-sm" onclick="on_rgb(this,7200)" value="2:00">
        <input type="submit" class="btn btn-primary btn-sm" onclick="on_rgb(this,10800)" value="3:00">
       </div>
       <hr>
       <h4>Время работы сигнала:</h4>
       <input class="form-control" value="0.1" pattern="[-+]?[0-9]*[.]?[0-9]+"  id="sound">
       <hr>
       <a href="#" onclick="document.getElementById('set-time').style.display='none';return false" class="btn btn-block btn-default">Отмена</a>
      </div>
     </div>
     <canvas id="cs" style="display:none;"></canvas>
     <input type="submit" class="btn btn-block btn-primary" onclick="led(this);" value="Включить\Выключить">
     <hr>
     <h2>Будильники</h2>
     <div class="row">
      <div class="col-sm-6">
       <h4>Будильник 1:</h4>
       <input id="time1" value="{{times1}}" pattern="(0[0-9]|1[0-9]|2[0-3])(:[0-5][0-9]){2}" class="form-control">
       <div class="btn-group" style="width:100%;">
        <input class="btn btn-success" style="width:70%;" value="Сохранить" onclick="set_time1(this);" type="submit">
        <input class="btn btn-default" style="width:30%;" value="Выкл." onclick="document.getElementById('time1').value='';set_time1(this);" type="submit">
       </div>
       <h4>Будильник 2:</h4>
       <input id="time2" value="{{times2}}" pattern="(0[0-9]|1[0-9]|2[0-3])(:[0-5][0-9]){2}" class="form-control">
       <div class="btn-group" style="width:100%;">
        <input class="btn btn-success" style="width:70%;" value="Сохранить" onclick="set_time2(this);" type="submit">
        <input class="btn btn-default" style="width:30%;" value="Выкл." onclick="document.getElementById('time2').value='';set_time2(this);" type="submit">
       </div>
      </div>
      <div class="col-sm-6">
       <div class="alert alert-dismissible alert-warning"><b>Обратите внимание</b> Настраивая время перед одиночными цифрами пишите 0. Пример: 03:09:10.
        Будильник будит повторять звонить каждый день.</div>
      </div>
     </div>
     <div class="row">
      <h2>Время работы будильника</h2>
      <div class="col-sm-8">
       <div class="alert alert-dismissible alert-info">Здесь указается время в секундах как долго будит звенеть будильник и гореть LED.</div>
      </div>
      <div class="col-sm-4">
       <div class="input-group">
        <input id="led" value="{{timeled}}" class="form-control" pattern="[0-9]*[.,]?[0-9]+">
        <span class="input-group-addon">сек.</span>
       </div>
       <input class="btn btn-block btn-success" value="Сохранить" onclick="set_time(this);" type="submit">
      </div>
     </div>
     <hr>
     <h2>Dynamic DNS Providers</h2>
     <div class="alert alert-dismissible alert-info">В 45 минут каждого часа устройство переходить по ссылке. Вы можете воспользоваться <a href="http://dyndns.dk" target="_blank">dyndns.dk</a> и таким образом сделать себе домен на динамическом IP. Что позволит комфортно пользоваться <a href="https://ifttt.com" target="_blank">ifttt.com</a></div>
     <input id="ddns" value="{{DDNS}}" class="form-control" pattern="http://.+">
     <input class="btn btn-block btn-success" value="Сохранить" onclick="ddns(this);" type="submit">
     <hr>
     <a class="btn btn-block btn-default" href="/setup.htm">Доп. настройки</a>
    </div>
   </div>
  </div>
 </body>
</html>
